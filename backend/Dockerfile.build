# =======================================================
# Care Voice å¾Œç«¯ç·¨è­¯éšæ®µ  
# ç›®æ¨™: Rust + Opus æ”¯æ´ç·¨è­¯
# =======================================================
FROM rust:1.85-slim AS backend-builder

LABEL stage="backend-build"
LABEL version="1.0.0"
LABEL description="Care Voice backend build stage - Rust + whisper-rs + Opus"

# å®‰è£ç³»çµ±ä¾è³´
RUN apt-get update && apt-get install -y \
    # Rust ç·¨è­¯å¿…éœ€
    pkg-config \
    libssl-dev \
    build-essential \
    # Opus éŸ³é »æ”¯æ´
    libopus-dev \
    libopus0 \
    # æ§‹å»ºå·¥å…·
    cmake \
    # ç¶²è·¯å·¥å…·
    curl \
    # æ¸…ç†ç·©å­˜
    && rm -rf /var/lib/apt/lists/* \
    && echo "âœ… å¾Œç«¯ç³»çµ±ä¾è³´å®‰è£å®Œæˆ"

# é©—è­‰ Opus åº«å¯ç”¨æ€§
RUN pkg-config --exists opus && \
    echo "âœ… Opus åº«æª¢æ¸¬æˆåŠŸ: $(pkg-config --modversion opus)" || \
    echo "âŒ Opus åº«æª¢æ¸¬å¤±æ•—"

WORKDIR /app

# å„ªåŒ– Rust ç·¨è­¯ (ä¾è³´å¿«å–å±¤)
# å…ˆè¤‡è£½ä¾è³´é…ç½®æ–‡ä»¶
COPY Cargo.toml Cargo.lock ./

# å‰µå»ºå‡çš„ main.rs ç”¨æ–¼ç·¨è­¯ä¾è³´
RUN mkdir src && \
    echo "fn main() { println!(\"Dependencies build\"); }" > src/main.rs

# ç·¨è­¯ä¾è³´ (åˆ©ç”¨å¿«å–)
RUN echo "ğŸ“¦ é–‹å§‹ç·¨è­¯ Rust ä¾è³´..." && \
    cargo build --release && \
    echo "âœ… ä¾è³´ç·¨è­¯å®Œæˆ" && \
    rm -rf src/

# è¤‡è£½å¯¦éš›æºä»£ç¢¼
COPY src/ ./src/

# è§¸ç¢° main.rs ç¢ºä¿é‡æ–°ç·¨è­¯æ‡‰ç”¨ä»£ç¢¼
RUN touch src/main.rs

# é‡æ–°ç·¨è­¯æ‡‰ç”¨ä»£ç¢¼ (åŒ…å« Opus æ”¯æ´)
RUN echo "ğŸ¦€ é–‹å§‹ç·¨è­¯ Care Voice å¾Œç«¯ (åŒ…å« Opus æ”¯æ´)..." && \
    RUST_LOG=info cargo build --release --features opus-support && \
    echo "âœ… å¾Œç«¯ç·¨è­¯å®Œæˆ"

# é©—è­‰ç·¨è­¯ç”¢å‡º
RUN ls -la target/release/ && \
    echo "ğŸ“Š å¾Œç«¯ç·¨è­¯ç”¢å‡º:" && \
    file target/release/care-voice && \
    echo "ğŸ“ äºŒé€²åˆ¶æ–‡ä»¶å¤§å°:" && \
    du -sh target/release/care-voice

# æª¢æŸ¥å‹•æ…‹é€£çµåº«ä¾è³´
RUN echo "ğŸ”— æª¢æŸ¥å‹•æ…‹é€£çµåº«ä¾è³´:" && \
    ldd target/release/care-voice || echo "éœæ…‹é€£çµæˆ–æª¢æŸ¥å¤±æ•—"

# åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦ (ç¢ºä¿ç·¨è­¯æ­£ç¢º)
RUN echo "ğŸ§ª åŸ·è¡ŒåŸºæœ¬åŠŸèƒ½æ¸¬è©¦..." && \
    cd target/release && \
    timeout 5s ./care-voice --version || echo "ç‰ˆæœ¬æª¢æŸ¥å®Œæˆ (å¯èƒ½ç„¡ --version åƒæ•¸)"

# æ¸…ç†ç·¨è­¯ç·©å­˜ (ä¿ç•™äºŒé€²åˆ¶)
RUN echo "ğŸ§¹ æ¸…ç†ç·¨è­¯ç·©å­˜..." && \
    rm -rf target/debug/ && \
    rm -rf target/release/build/ && \
    rm -rf target/release/deps/ && \
    find target/release/ -name "*.d" -delete && \
    echo "âœ… æ¸…ç†å®Œæˆï¼Œä¿ç•™äºŒé€²åˆ¶æ–‡ä»¶"

# æ¨™è¨˜ç·¨è­¯å®Œæˆç‹€æ…‹
RUN echo "backend-build-complete-$(date)" > /app/build-status && \
    echo "âœ… å¾Œç«¯ç·¨è­¯éšæ®µå®Œæˆ"

# å¥åº·æª¢æŸ¥ - é©—è­‰äºŒé€²åˆ¶æ–‡ä»¶å­˜åœ¨ä¸”å¯åŸ·è¡Œ
HEALTHCHECK --interval=30s --timeout=10s --retries=2 \
    CMD test -x /app/target/release/care-voice || exit 1

# è¨­å®šå·¥ä½œç›®éŒ„ç‚ºç”¢å‡ºç›®éŒ„
WORKDIR /app/target/release

# é è¨­å‘½ä»¤ (é€šå¸¸ä¸æœƒåŸ·è¡Œï¼Œåƒ…ç”¨æ–¼èª¿è©¦)
CMD ["echo", "Backend build completed. Binary available at /app/target/release/care-voice"]
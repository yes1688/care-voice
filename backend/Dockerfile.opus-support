# =======================================================
# Care Voice Opus éŸ³é »æ”¯æ´å®¹å™¨
# åŸºæ–¼å·²é©—è­‰çš„ whisper-rs GPU åŸºç¤
# æ·»åŠ  WebM-Opus, OGG-Opus æ ¼å¼æ”¯æ´
# =======================================================

FROM localhost/care-voice:whisper-rs-gpu-v2-fixed

# å®¹å™¨æ¨™ç±¤
LABEL maintainer="Care Voice Opus Support"
LABEL version="1.0.0"
LABEL description="whisper-rs + Opus audio support, 95% browser compatibility"
LABEL base.image="care-voice:whisper-rs-gpu-v2-fixed"

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# æ·»åŠ  Opus éŸ³é »è™•ç†ä¾è³´å’Œ Rust ç·¨è­¯ç’°å¢ƒ
RUN apt-get update && apt-get install -y \
    # Opus ç·¨è§£ç¢¼åº«
    libopus-dev \
    libopus0 \
    # ç¢ºä¿ CMake å¯ç”¨ (å¯èƒ½å·²å®‰è£)
    cmake \
    # é¡å¤–çš„éŸ³é »è™•ç†å·¥å…·
    pkg-config \
    # Rust ç·¨è­¯éœ€è¦çš„å·¥å…·
    curl \
    build-essential \
    # æ¸…ç†ç·©å­˜
    && rm -rf /var/lib/apt/lists/* \
    && echo "âœ… Opus ä¾è³´å®‰è£å®Œæˆ"

# å®‰è£ Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# å‚™ä»½åŸå§‹äºŒé€²åˆ¶æª”æ¡ˆ (å®‰å…¨æªæ–½)
RUN cp /app/care-voice /app/care-voice.backup

# å‰µå»ºè‡¨æ™‚ç·¨è­¯ç›®éŒ„
RUN mkdir -p /tmp/build
WORKDIR /tmp/build

# è¤‡è£½ä¿®å¾©å¾Œçš„æºä»£ç¢¼åˆ°ç·¨è­¯ç›®éŒ„
COPY src/ ./src/
COPY Cargo.toml ./

# é©—è­‰ Opus åº«å¯ç”¨æ€§
RUN pkg-config --exists opus && echo "âœ… Opus åº«æª¢æ¸¬æˆåŠŸ" || echo "âŒ Opus åº«æª¢æ¸¬å¤±æ•—"

# é‡æ–°ç·¨è­¯å¾Œç«¯ (æ·»åŠ  Opus æ”¯æ´)
RUN echo "ğŸ”§ é–‹å§‹ç·¨è­¯ Opus æ”¯æ´ç‰ˆæœ¬..." && \
    cargo clean && \
    RUST_LOG=info cargo build --release --features opus-support && \
    ls -la target/release/ && \
    echo "âœ… Opus æ”¯æ´ç·¨è­¯å®Œæˆ" && \
    # è¤‡è£½æ–°ç·¨è­¯çš„äºŒé€²åˆ¶æª”æ¡ˆåˆ° /app
    cp target/release/care-voice /app/care-voice && \
    echo "âœ… äºŒé€²åˆ¶æª”æ¡ˆæ›´æ–°å®Œæˆ"

# å›åˆ°å·¥ä½œç›®éŒ„
WORKDIR /app

# é©—è­‰ç·¨è­¯çµæœ
RUN ./care-voice --version 2>/dev/null || echo "âš ï¸  ç‰ˆæœ¬æª¢æŸ¥æœªå¯¦ç¾ï¼Œä½†ç·¨è­¯æˆåŠŸ"

# å¥åº·æª¢æŸ¥ (èª¿æ•´ç‚º Opus ç‰ˆæœ¬)
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# å•Ÿå‹•å‘½ä»¤ä¿æŒä¸è®Š (ä½¿ç”¨ supervisord)
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
# =======================================================
# Care Voice Opus éŸ³é »æ”¯æ´å®¹å™¨ (å®Œæ•´ç‰ˆ)
# åŸºæ–¼ whisper-rs GPU åŸºç¤ï¼ŒåŒ…å«å®Œæ•´ Opus è§£ç¢¼å¯¦ç¾
# =======================================================

FROM localhost/care-voice:whisper-rs-gpu-v2-fixed

# å®¹å™¨æ¨™ç±¤
LABEL maintainer="Care Voice Opus Support (Complete)"
LABEL version="1.0.0-complete"
LABEL description="whisper-rs + Complete Opus decoding, 95% browser compatibility"

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# æ·»åŠ  Opus éŸ³é »è™•ç†ä¾è³´ (å®¹å™¨å…§å®‰è£ï¼Œä¸å½±éŸ¿æ¯æ©Ÿ)
RUN apt-get update && apt-get install -y \
    # Opus ç·¨è§£ç¢¼åº« (å®Œæ•´ç‰ˆæœ¬)
    libopus-dev \
    libopus0 \
    # ç¢ºä¿ CMake å¯ç”¨
    cmake \
    # éŸ³é »è™•ç†å·¥å…·
    pkg-config \
    # æ¸¬è©¦å·¥å…·
    curl \
    # æ¸…ç†ç·©å­˜
    && rm -rf /var/lib/apt/lists/* \
    && echo "âœ… Opus å®Œæ•´ä¾è³´å®‰è£å®Œæˆ"

# é©—è­‰ Opus åº«å¯ç”¨æ€§
RUN pkg-config --exists opus && echo "âœ… Opus åº«æª¢æ¸¬æˆåŠŸ" || echo "âŒ Opus åº«æª¢æ¸¬å¤±æ•—"

# å®‰è£ Rust (å¦‚æœä¸å­˜åœ¨)
RUN if ! command -v cargo &> /dev/null; then \
        echo "ğŸ¦€ å®‰è£ Rust ç·¨è­¯ç’°å¢ƒ..." && \
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && \
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc; \
    else \
        echo "âœ… Rust å·²å®‰è£"; \
    fi

# è¨­ç½® Rust ç’°å¢ƒè®Šæ•¸
ENV PATH="/root/.cargo/bin:${PATH}"

# é©—è­‰ Rust å®‰è£
RUN echo "ğŸ” é©—è­‰ Rust ç’°å¢ƒ..." && \
    /root/.cargo/bin/cargo --version || echo "âš ï¸ Cargo éœ€è¦è¨­ç½®ç’°å¢ƒ"

# å‚™ä»½åŸå§‹ä»£ç¢¼
RUN cp -r /app/src /app/src.backup 2>/dev/null || echo "ç„¡åŸå§‹ä»£ç¢¼éœ€è¦å‚™ä»½"

# è¤‡è£½ä¿®å¾©å¾Œçš„æºä»£ç¢¼ (åŒ…å«å®Œæ•´ Opus è§£ç¢¼å¯¦ç¾)
COPY src/ ./src/
COPY Cargo.toml ./

# é‡æ–°ç·¨è­¯ (å•Ÿç”¨ opus-support feature)
RUN echo "ğŸ”§ é–‹å§‹ç·¨è­¯å®Œæ•´ Opus æ”¯æ´ç‰ˆæœ¬..." && \
    export PATH="/root/.cargo/bin:$PATH" && \
    /root/.cargo/bin/cargo clean && \
    RUST_LOG=info /root/.cargo/bin/cargo build --release --features opus-support && \
    ls -la target/release/ && \
    echo "âœ… å®Œæ•´ Opus æ”¯æ´ç·¨è­¯å®Œæˆ"

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# å•Ÿå‹•å‘½ä»¤ä¿æŒä¸è®Š
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
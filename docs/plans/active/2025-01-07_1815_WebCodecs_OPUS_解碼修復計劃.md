# WebCodecs OPUS è§£ç¢¼ä¿®å¾©è¨ˆåŠƒ

---
plan_id: webcodecs-opus-decoding-fix
status: active
priority: critical
category: bug-fix
created: 2025-01-07T18:15:00Z
updated: 2025-01-07T18:15:00Z
assignee: claude-code
estimated_hours: 2
tags: [webcodecs, opus, audio-decoding, rust, transcription]
---

## ğŸš¨ å•é¡Œæ¦‚è¿°

Care Voice èªéŸ³è½‰éŒ„ç³»çµ±åœ¨è™•ç† WebCodecs OPUS éŸ³é »æ™‚å‡ºç¾åš´é‡å“è³ªå•é¡Œï¼Œè½‰éŒ„çµæœç‚ºç„¡æ„ç¾©é‡è¤‡æ–‡å­—ï¼Œè€Œéæ­£ç¢ºçš„ä¸­æ–‡èªéŸ³å…§å®¹ã€‚

### ç—‡ç‹€
- **éŒ¯èª¤è¼¸å‡º**ï¼š`"è«‹ä¸å„é»è³‡ è¨‚é–± è½‰ç™¼ æ‰“è³æ”¯æŒæ˜é¡èˆ‡é»æ“Šç›®è«‹ä¸å„é»è³‡ è¨‚é–± è½‰ç™¼ æ‰“è³æ”¯æŒæ˜é¡èˆ‡é»æ“Šç›®"`
- **é æœŸè¼¸å‡º**ï¼š`"ç¥èªªè¦æœ‰äº†å…‰å°±æœ‰...."`
- **æŠ€è¡“éŒ¯èª¤**ï¼š28% OPUS åŒ…è§£ç¢¼å¤±æ•—ï¼Œéœ€è¦ FEC æ¢å¾©
- **ç³»çµ±éŒ¯èª¤**ï¼šè½‰éŒ„è¶…æ™‚ (30ç§’)

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### åˆæ­¥è¨ºæ–·
1. **å¤§é‡åŒ…æå£**ï¼š401-436 å€‹åŒ…ä¸­ç´„ 30% å‡ºç¾ `corrupted stream` éŒ¯èª¤
2. **æ™ºèƒ½æ‹†åˆ†å•é¡Œ**ï¼šWebCodecs åŸå§‹æµæ‹†åˆ†ç®—æ³•ä¸æº–ç¢º
3. **éŸ³é »å“è³ªå—æ**ï¼šFEC æ¢å¾©é›–æˆåŠŸä½†éŸ³é »å“è³ªä¸‹é™
4. **è½‰éŒ„æ¨¡å‹å›°é›£**ï¼šå—æéŸ³é »å°è‡´ Whisper è™•ç†å›°é›£

### æ¥­ç•Œæ¨™æº–ç ”ç©¶ç™¼ç¾

é€šéå°æœ€æ–°æ¥­ç•Œæ¨™æº–çš„æ·±å…¥ç ”ç©¶ï¼Œç™¼ç¾**æˆ‘å€‘çš„ä¿®å¾©æ–¹å‘å®Œå…¨éŒ¯èª¤**ï¼š

#### âŒ éŒ¯èª¤å‡è¨­
1. **é€£çºŒæµå‡è¨­**ï¼šä»¥ç‚º WebCodecs è¼¸å‡ºé€£çºŒçš„ OPUS æµ
2. **æ•´é«”è§£ç¢¼å˜—è©¦**ï¼šè©¦åœ–å°‡ 139KB æ•¸æ“šä½œç‚ºå–®å€‹åŒ…è§£ç¢¼
3. **å¿½ç•¥ç‹€æ…‹ç®¡ç†**ï¼šæœªè€ƒæ…® OPUS æœ‰ç‹€æ…‹ç‰¹æ€§

#### âœ… æ¥­ç•Œæ¨™æº–äº‹å¯¦
1. **ç¨ç«‹åŒ…åºåˆ—**ï¼šWebCodecs è¼¸å‡º `EncodedAudioChunk` å°è±¡åºåˆ—ï¼Œæ¯å€‹æ˜¯ç¨ç«‹ OPUS åŒ…
2. **æœ‰ç‹€æ…‹è§£ç¢¼**ï¼šOPUS æ˜¯æœ‰ç‹€æ…‹ç·¨è§£ç¢¼å™¨ï¼ŒåŒ…é–“æœ‰é‡ç–Šå€å¡Šï¼Œéœ€è¦é †åºè™•ç†
3. **åŒ…ç´šè™•ç†**ï¼šæ¨™æº–åšæ³•æ˜¯ç¶­æŒå–®ä¸€è§£ç¢¼å™¨å¯¦ä¾‹ï¼Œé€åŒ…è§£ç¢¼

## ğŸ¯ æŠ€è¡“è§£æ±ºæ–¹æ¡ˆ

### æ ¸å¿ƒä¿®å¾©ç­–ç•¥

åŸºæ–¼ [Opus WebCodecs Registration](https://w3c.github.io/webcodecs/opus_codec_registration.html) å’Œ [Rust opus crate æ–‡æª”](https://docs.rs/opus/)ï¼š

#### 1. **æ­£ç¢ºçš„ OPUS è§£ç¢¼æ¨¡å¼**
```rust
// æ¥­ç•Œæ¨™æº–åšæ³•
let mut decoder = Decoder::new(sample_rate, channels)?;
for packet in opus_packets {
    let decoded_audio = decoder.decode_float(packet, &mut output, false)?;
    // ç¶­æŒè§£ç¢¼å™¨ç‹€æ…‹ï¼Œè™•ç†æœ‰ç‹€æ…‹é‡ç–Š
}
```

#### 2. **æ”¹å–„åŒ…é‚Šç•Œæª¢æ¸¬**
- åŸºæ–¼ OPUS TOC (Table of Contents) å­—ç¯€ç²¾ç¢ºè­˜åˆ¥
- ä½¿ç”¨å¯¦éš›åŒ…é•·åº¦è€Œéå›ºå®šå¤§å°æ‹†åˆ†
- å¯¦ä½œæ™ºèƒ½åŒ…é©—è­‰æ©Ÿåˆ¶

#### 3. **ç‹€æ…‹ç®¡ç†å„ªåŒ–**
- å–®ä¸€è§£ç¢¼å™¨å¯¦ä¾‹è²«ç©¿æ•´å€‹æœƒè©±
- æ­£ç¢ºè™•ç†åŒ…é–“ç‹€æ…‹ä¾è³´
- å¯¦ä½œéŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶

## ğŸ“‹ å¯¦æ–½è¨ˆåŠƒ

### Phase 1: ç§»é™¤éŒ¯èª¤é‚è¼¯
- [ ] ç§»é™¤ `decode_webcodecs_continuous_stream` å‡½æ•¸
- [ ] æ¢å¾©åˆ°æ”¹é€²çš„åŒ…ç´šè™•ç†é‚è¼¯
- [ ] æ¸…ç†ç›¸é—œéŒ¯èª¤è™•ç†ä»£ç¢¼

### Phase 2: é‡å¯«åŒ…æ‹†åˆ†ç®—æ³•
- [ ] å¯¦ä½œåŸºæ–¼ TOC å­—ç¯€çš„åŒ…é‚Šç•Œæª¢æ¸¬
- [ ] æ”¹å–„åŒ…å¤§å°é æ¸¬ç®—æ³•
- [ ] å¢åŠ åŒ…å®Œæ•´æ€§é©—è­‰

### Phase 3: å„ªåŒ–è§£ç¢¼å™¨ç‹€æ…‹ç®¡ç†
- [ ] ä¿®æ”¹è§£ç¢¼å™¨æ± å¯¦ç¾
- [ ] ç¢ºä¿å–®ä¸€è§£ç¢¼å™¨å¯¦ä¾‹æŒçºŒæ€§
- [ ] å¯¦ä½œç‹€æ…‹éŒ¯èª¤æ¢å¾©

### Phase 4: ç³»çµ±ç´šå„ªåŒ–
- [ ] èª¿æ•´è½‰éŒ„è¶…æ™‚å¾ 30s åˆ° 60-90s
- [ ] æ”¹å–„éŒ¯èª¤è¨Šæ¯å’Œç”¨æˆ¶åé¥‹
- [ ] å¢åŠ è™•ç†é€²åº¦æŒ‡ç¤ºå™¨

### Phase 5: æ¸¬è©¦é©—è­‰
- [ ] æ¸¬è©¦ç›¸åŒèªéŸ³æ¨£æœ¬ `"ç¥èªªè¦æœ‰äº†å…‰å°±æœ‰...."`
- [ ] é©—è­‰åŒ…éŒ¯èª¤ç‡ < 5%
- [ ] ç¢ºèªè½‰éŒ„çµæœæ­£ç¢ºæ€§
- [ ] æ€§èƒ½åŸºæº–æ¸¬è©¦

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

### æ¸¬è©¦æ¡ˆä¾‹
1. **åŸºç¤åŠŸèƒ½æ¸¬è©¦**
   - è¼¸å…¥ï¼šä¸­æ–‡èªéŸ³ "ç¥èªªè¦æœ‰äº†å…‰å°±æœ‰...."
   - é æœŸï¼šæ­£ç¢ºçš„ä¸­æ–‡è½‰éŒ„çµæœ
   - æˆåŠŸæ¨™æº–ï¼šè½‰éŒ„æº–ç¢ºåº¦ > 90%

2. **åŒ…è§£ç¢¼å“è³ªæ¸¬è©¦**
   - ç›£æ§ï¼šåŒ…è§£ç¢¼éŒ¯èª¤ç‡
   - ç›®æ¨™ï¼š< 5% åŒ…è§£ç¢¼å¤±æ•—
   - ç„¡éœ€ï¼šå¤§é‡ FEC æ¢å¾©

3. **æ€§èƒ½æ¸¬è©¦**
   - è½‰éŒ„å»¶é²ï¼š< 60 ç§’
   - ç³»çµ±éŸ¿æ‡‰ï¼šç„¡è¶…æ™‚éŒ¯èª¤
   - è³‡æºä½¿ç”¨ï¼šåˆç†çš„ CPU/å…§å­˜æ¶ˆè€—

### é©—æ”¶æ¨™æº–
- âœ… æ­£ç¢ºçš„ä¸­æ–‡èªéŸ³è½‰éŒ„
- âœ… åŒ…éŒ¯èª¤ç‡ < 5%
- âœ… ç„¡è½‰éŒ„è¶…æ™‚éŒ¯èª¤
- âœ… ç¬¦åˆæ¥­ç•Œ OPUS è™•ç†æ¨™æº–

## ğŸ“Š é¢¨éšªè©•ä¼°

### é«˜é¢¨éšª
- **è§£ç¢¼å™¨ API æ›´æ”¹**ï¼šå¯èƒ½å½±éŸ¿å…¶ä»–éŸ³é »æ ¼å¼æ”¯æ´
- **ç‹€æ…‹ç®¡ç†è¤‡é›œæ€§**ï¼šå¤šç·šç¨‹ç’°å¢ƒä¸‹çš„ç‹€æ…‹åŒæ­¥

### ä¸­é¢¨éšª
- **æ€§èƒ½å½±éŸ¿**ï¼šå„ªåŒ–å¾Œçš„æ‹†åˆ†ç®—æ³•å¯èƒ½å½±éŸ¿è™•ç†é€Ÿåº¦
- **ç›¸å®¹æ€§å•é¡Œ**ï¼šä¸åŒç€è¦½å™¨ WebCodecs å¯¦ä½œå·®ç•°

### ç·©è§£ç­–ç•¥
- ä¿ç•™åŸæœ‰é‚è¼¯ä½œç‚ºå¾Œå‚™æ–¹æ¡ˆ
- æ®µéšæ€§éƒ¨ç½²å’Œæ¸¬è©¦
- è©³ç´°çš„éŒ¯èª¤æ—¥èªŒå’Œç›£æ§

## ğŸ”„ å›æ»¾è¨ˆåŠƒ

å¦‚æœä¿®å¾©å¤±æ•—ï¼š
1. æ¢å¾© git æäº¤ï¼š`git reset --hard HEAD~1`
2. é‡æ–°å•Ÿå‹•æœå‹™ï¼š`./start.sh`
3. é©—è­‰ç³»çµ±åŸºæœ¬åŠŸèƒ½
4. é‡æ–°è©•ä¼°è§£æ±ºæ–¹æ¡ˆ

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

### å®šé‡æŒ‡æ¨™
- åŒ…è§£ç¢¼æˆåŠŸç‡ï¼š> 95%
- è½‰éŒ„æº–ç¢ºåº¦ï¼š> 90%
- è™•ç†å»¶é²ï¼š< 60 ç§’
- ç³»çµ±å¯ç”¨æ€§ï¼š> 99%

### å®šæ€§æŒ‡æ¨™
- ç”¨æˆ¶åé¥‹æ­£é¢
- è½‰éŒ„çµæœæœ‰æ„ç¾©
- ç³»çµ±éŸ¿æ‡‰ç©©å®š
- ç¬¦åˆæ¥­ç•Œæ¨™æº–

## ğŸ“š åƒè€ƒè³‡æ–™

### æŠ€è¡“æ¨™æº–
- [WebCodecs Opus Codec Registration](https://w3c.github.io/webcodecs/opus_codec_registration.html)
- [RFC 6716: Definition of the Opus Audio Codec](https://datatracker.ietf.org/doc/html/rfc6716)
- [Opus Codec Official Documentation](https://opus-codec.org/docs/)

### å¯¦ä½œåƒè€ƒ
- [Rust opus crate](https://docs.rs/opus/)
- [WebCodecs AudioEncoder MDN](https://developer.mozilla.org/en-US/docs/Web/API/AudioEncoder)
- [OPUS Decoder API](https://opus-codec.org/docs/opus_api-1.5/group__opus__decoder.html)

### ç¤¾ç¾¤è¨è«–
- [Stack Overflow: WebCodecs OPUS Frames](https://stackoverflow.com/questions/73665100/using-web-api-audioencoder-to-output-opus-frames)
- [GitHub Issue: WebCodecs Opus Implementation](https://github.com/xiph/opus/issues/221)

---

**è¨ˆåŠƒå»ºç«‹æ™‚é–“**: 2025-01-07T18:15:00Z  
**é ä¼°å®Œæˆæ™‚é–“**: 2025-01-07T20:00:00Z  
**è² è²¬äºº**: Claude Code AI Assistant  
**ç‹€æ…‹**: âœ… Active - å·²æ ¸å‡†å¯¦æ–½  
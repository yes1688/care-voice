# ğŸ” WebM éŸ³é »æ ¼å¼è½‰æ›å•é¡ŒæŠ€è¡“åˆ†æ

## ğŸ“‹ å•é¡Œæ¦‚è¦

**å•é¡Œæè¿°**: ç€è¦½å™¨éŒ„éŸ³ä¸Šå‚³æ™‚å‡ºç¾ `HTTP 422 Unprocessable Entity` éŒ¯èª¤ï¼Œæç¤º "Audio format conversion failed"

**éŒ¯èª¤ç™¼ç”Ÿæ™‚é–“**: 2025-07-26  
**å½±éŸ¿ç¯„åœ**: æ‰€æœ‰ä½¿ç”¨ç€è¦½å™¨ MediaRecorder API çš„éŒ„éŸ³åŠŸèƒ½  
**ç•¶å‰ç‹€æ…‹**: é˜»æ–·æ€§å•é¡Œï¼Œç”¨æˆ¶ç„¡æ³•å®ŒæˆèªéŸ³è½‰éŒ„

---

## ğŸ”¬ æŠ€è¡“ç´°ç¯€åˆ†æ

### å‰ç«¯éŸ³é »éŒ„è£½æµç¨‹

#### MediaRecorder API è¡Œç‚ºåˆ†æ
```typescript
// å‰ç«¯éŒ„éŸ³æ ¼å¼é¸æ“‡é‚è¼¯ (frontend/src/App.tsx:32-57)
const wavFormats = [
  'audio/wav',      // ç†æƒ³æ ¼å¼ï¼Œç›´æ¥æ”¯æ´
  'audio/wave', 
  'audio/x-wav'
];

const fallbackFormats = [
  'audio/webm',     // Chrome ä¸»è¦ä½¿ç”¨ (Opus ç·¨ç¢¼)
  'audio/ogg'       // Firefox ä¸»è¦ä½¿ç”¨ (Vorbis ç·¨ç¢¼)
];
```

#### å¯¦éš›éŒ„éŸ³çµæœ
```
âš ï¸ ä½¿ç”¨ audio/webm (éœ€è¦æœå‹™å™¨ç«¯è½‰æ›)
éŒ„éŸ³å®Œæˆï¼Œæ ¼å¼: audio/webm, å¤§å°: 88531 bytes
ä¸Šå‚³éŸ³é »æª”æ¡ˆ: recording.ogg, MIMEé¡å‹: audio/webm
```

**å•é¡Œç™¼ç¾**: æ–‡ä»¶åç‚º `.ogg` ä½†å¯¦éš› MIME é¡å‹æ˜¯ `audio/webm`ï¼Œé€ æˆæ ¼å¼è­˜åˆ¥æ··æ·†

### å¾Œç«¯éŸ³é »è™•ç†æµç¨‹

#### symphonia åº«é…ç½® (backend/Cargo.toml:18-21)
```toml
symphonia = { version = "0.5", features = [
    "mkv",          # WebM/Matroska å®¹å™¨æ”¯æ´ âœ…
    "vorbis"        # Vorbis ç·¨è§£ç¢¼å™¨ âœ… (Firefox)
] }
```

**ç¼ºå¤±çš„é—œéµé…ç½®**:
- âŒ `"opus"` ç·¨è§£ç¢¼å™¨æ”¯æ´ (Chrome WebM ä¸»è¦æ ¼å¼)
- âŒ `"webm"` æ˜ç¢ºå®¹å™¨æ ¼å¼æ”¯æ´

#### éŒ¯èª¤è¿½è¹¤åˆ†æ

1. **æ ¼å¼æ¢æ¸¬éšæ®µ** (main.rs:275-292)
   ```rust
   let mut hint = Hint::new();
   hint.with_extension("webm");
   hint.with_extension("ogg");
   ```
   - æç¤ºé…ç½®æ­£ç¢º âœ…
   - ä½†ç¼ºå°‘ Opus è§£ç¢¼å™¨ âŒ

2. **å…·é«”éŒ¯èª¤ä¿¡æ¯**
   ```
   [ERROR] æ ¼å¼æ¢æ¸¬å¤±æ•—: end of stream
   [ERROR] Failed to decode audio: éŸ³é »æ–‡ä»¶å¯èƒ½å·²å®Œå…¨è§£æï¼Œä½†ç¼ºå°‘å°¾éƒ¨ä¿¡æ¯
   ```

3. **æ ¹æœ¬åŸå› **
   - Chrome WebM ä½¿ç”¨ **Opus ç·¨ç¢¼**ï¼Œä½† symphonia åªé…ç½®äº† Vorbis
   - `end of stream` éŒ¯èª¤è¡¨ç¤ºç„¡æ³•è­˜åˆ¥ Opus ç·¨ç¢¼çš„éŸ³é »æ•¸æ“š

---

## ğŸŒ ç€è¦½å™¨éŸ³é »æ ¼å¼æ”¯æ´çŸ©é™£

| ç€è¦½å™¨ | å„ªå…ˆæ ¼å¼ | ç·¨ç¢¼å™¨ | å®¹å™¨ | symphonia æ”¯æ´ |
|--------|----------|--------|------|----------------|
| **Chrome** | audio/webm | **Opus** | WebM | âŒ ç¼ºå°‘ opus ç‰¹æ€§ |
| **Firefox** | audio/webm | Vorbis | WebM | âœ… å®Œæ•´æ”¯æ´ |
| **Safari** | audio/wav | PCM | WAV | âœ… hound è™•ç† |
| **Edge** | audio/webm | **Opus** | WebM | âŒ ç¼ºå°‘ opus ç‰¹æ€§ |

**é—œéµç™¼ç¾**: ä¸»æµç€è¦½å™¨ (Chrome/Edge) ä½¿ç”¨ Opus ç·¨ç¢¼ï¼Œä½†ç•¶å‰å¾Œç«¯ä¸æ”¯æ´

---

## ğŸ” éŒ¯èª¤å †æ£§è¿½è¹¤

### å‰ç«¯éŒ¯èª¤æµç¨‹
1. MediaRecorder éŒ„è£½ â†’ `audio/webm` (Opus)
2. ä¸Šå‚³åˆ° `/api/upload` 
3. æ–‡ä»¶åéŒ¯èª¤æ¨™è¨˜ç‚º `.ogg`

### å¾Œç«¯éŒ¯èª¤æµç¨‹
1. `upload_audio()` æ¥æ”¶ 88531 bytes âœ…
2. `convert_to_wav_samples()` å˜—è©¦è½‰æ› âœ…
3. `try_read_as_wav()` å¤±æ•— (é æœŸ) âœ…
4. `try_decode_with_symphonia()` **å¤±æ•—** âŒ
5. æ ¼å¼æ¢æ¸¬å¤±æ•—: `end of stream` âŒ
6. è¿”å› 422 éŒ¯èª¤ âŒ

### è©³ç´°æ—¥èªŒåˆ†æ
```
[INFO] Received audio data: 88531 bytes                    âœ… æ•¸æ“šæ¥æ”¶æ­£å¸¸
[INFO] Converting audio data to WAV samples                âœ… é–‹å§‹è½‰æ›
[INFO] é–‹å§‹ä½¿ç”¨ symphonia è§£ç¢¼éŸ³é »æ•¸æ“šï¼Œå¤§å°: 88531 bytes   âœ… symphonia å•Ÿå‹•
[ERROR] æ ¼å¼æ¢æ¸¬å¤±æ•—: end of stream                        âŒ é—œéµå¤±æ•—é»
[ERROR] Failed to decode audio                             âŒ è½‰æ›å¤±æ•—
[ERROR] Audio conversion failed                            âŒ æœ€çµ‚éŒ¯èª¤
```

---

## ğŸ¯ å•é¡Œæ ¹å› ç¸½çµ

### ä¸»è¦åŸå› 
1. **ä¾è³´é…ç½®ä¸å®Œæ•´**: symphonia ç¼ºå°‘ `opus` ç·¨è§£ç¢¼å™¨æ”¯æ´
2. **ç€è¦½å™¨ç›¸å®¹æ€§**: Chrome/Edge ä¸»è¦ä½¿ç”¨ Opusï¼Œä½†å¾Œç«¯åªæ”¯æ´ Vorbis
3. **éŒ¯èª¤è™•ç†ä¸è¶³**: æ ¼å¼æ¢æ¸¬å¤±æ•—æ™‚ç¼ºå°‘è©³ç´°è¨ºæ–·ä¿¡æ¯

### æ¬¡è¦åŸå› 
1. **æ–‡ä»¶åæ··æ·†**: `.ogg` æ–‡ä»¶åä½†å¯¦éš›æ˜¯ WebM æ ¼å¼
2. **æ ¼å¼æç¤ºè¡çª**: åŒæ™‚æç¤º webm å’Œ ogg å¯èƒ½é€ æˆæ··æ·†
3. **ç¼ºå°‘å›é€€æ©Ÿåˆ¶**: æ²’æœ‰å‚™ç”¨çš„éŸ³é »è½‰æ›æ–¹æ¡ˆ

### æŠ€è¡“å‚µå‹™
1. **æ¸¬è©¦è¦†è“‹ä¸è¶³**: ç¼ºå°‘å„ç€è¦½å™¨éŸ³é »æ ¼å¼æ¸¬è©¦
2. **æ–‡æª”ä¸å®Œæ•´**: éŸ³é »æ”¯æ´æ ¼å¼æ–‡æª”ç¼ºå¤±
3. **ç›£æ§ä¸è¶³**: ç¼ºå°‘éŸ³é »è½‰æ›æˆåŠŸç‡ç›£æ§

---

## ğŸš¨ å½±éŸ¿è©•ä¼°

### ç”¨æˆ¶é«”é©—å½±éŸ¿
- **åš´é‡åº¦**: ğŸ”´ é«˜ (åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨)
- **å½±éŸ¿ç”¨æˆ¶**: Chrome/Edge ç”¨æˆ¶ (~70% å¸‚å ´ä½”æœ‰ç‡)
- **å·¥ä½œæµç¨‹**: å®Œå…¨é˜»æ–·éŒ„éŸ³è½‰éŒ„åŠŸèƒ½

### æŠ€è¡“å½±éŸ¿
- **ç³»çµ±ç©©å®šæ€§**: ç„¡å½±éŸ¿ (å„ªé›…éŒ¯èª¤è™•ç†)
- **æ€§èƒ½å½±éŸ¿**: ç„¡å½±éŸ¿
- **ç¶­è­·æˆæœ¬**: ä¸­ç­‰ (éœ€è¦ä¾è³´æ›´æ–°)

### æ¥­å‹™å½±éŸ¿
- **åŠŸèƒ½å®Œæ•´æ€§**: æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
- **ç”¨æˆ¶ä¿¡ä»»**: å¯èƒ½å½±éŸ¿ç”¢å“å¯é æ€§èªçŸ¥
- **ç«¶çˆ­åŠ›**: èˆ‡å…¶ä»–èªéŸ³è½‰éŒ„æœå‹™å·®è·

---

## ğŸ“Š ç›¸é—œæŠ€è¡“è³‡æ–™

### symphonia æ”¯æ´çš„ç·¨è§£ç¢¼å™¨
```toml
# ç•¶å‰é…ç½®
symphonia = { version = "0.5", features = ["mkv", "vorbis"] }

# éœ€è¦çš„å®Œæ•´é…ç½®
symphonia = { version = "0.5", features = [
    "mkv",          # WebM/Matroska å®¹å™¨
    "vorbis",       # Firefox WebM (Vorbis)
    "opus",         # Chrome WebM (Opus) â† ç¼ºå¤±
    "flac",         # å¯é¸: FLAC æ”¯æ´
    "mp3"           # å¯é¸: MP3 æ”¯æ´
] }
```

### WebM æ ¼å¼æŠ€è¡“è¦æ ¼
- **å®¹å™¨**: Matroska åŸºç¤ (MKV)
- **éŸ³é »ç·¨ç¢¼**: Opus (Google) æˆ– Vorbis (Xiph.Org)
- **Chrome åå¥½**: Opus (æ›´å¥½çš„å£“ç¸®ç‡å’Œå“è³ª)
- **Firefox åå¥½**: Vorbis (é–‹æºå‚³çµ±)

### éŸ³é »æ•¸æ“šæµåˆ†æ
```
WebM Container (88531 bytes)
â”œâ”€â”€ EBML Header      (~40 bytes)
â”œâ”€â”€ Segment Header   (~100 bytes)
â”œâ”€â”€ Track Info       (~200 bytes)
â”œâ”€â”€ Opus Audio Data  (~88000 bytes)  â† symphonia ç„¡æ³•è§£æ
â””â”€â”€ Segment Footer   (~191 bytes)    â† "end of stream" éŒ¯èª¤ä½ç½®
```

---

*æœ¬æ–‡æª”å»ºç«‹æ–¼ 2025-07-26ï¼Œè¨˜éŒ„ Care Voice whisper-rs å°ˆæ¡ˆçš„ WebM éŸ³é »è½‰æ›å•é¡Œå®Œæ•´æŠ€è¡“åˆ†æ*
FROM docker.io/library/python:3.11-slim

RUN apt-get update && apt-get install -y \
    nginx \
    supervisor \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

RUN groupadd -g 1000 app && \
    useradd -u 1000 -g app -m -s /bin/bash app && \
    mkdir -p /app/models /var/log/supervisor /run/nginx

RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

COPY frontend/dist /usr/share/nginx/html
RUN chown -R www-data:www-data /usr/share/nginx/html

COPY gpu_whisper_server.py /app/
RUN chmod +x /app/gpu_whisper_server.py

COPY unified-nginx.conf /etc/nginx/nginx.conf
COPY supervisord_gpu.conf /etc/supervisor/supervisord.conf

RUN mkdir -p /var/log/nginx /var/log/supervisor && \
    chown -R www-data:www-data /var/log/nginx && \
    chown -R app:app /app

WORKDIR /app
EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]
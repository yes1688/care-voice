# =======================================================
# Care Voice å‰ç«¯ç·¨è­¯éšæ®µ
# ç›®æ¨™: SolidJS + Vite ç·¨è­¯ç”¢å‡º dist/
# =======================================================
FROM node:20-slim AS frontend-builder

LABEL stage="frontend-build"
LABEL version="1.0.0"
LABEL description="Care Voice frontend build stage - SolidJS + Vite"

WORKDIR /app

# å®‰è£å¿…è¦çš„ç³»çµ±å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å„ªåŒ–ä¾è³´å®‰è£ (åˆ©ç”¨ Docker å¿«å–å±¤)
COPY package.json package-lock.json ./

# å®‰è£ä¾è³´ (åƒ…ç”Ÿç”¢ä¾è³´ä»¥åŠ é€Ÿ)
RUN npm ci --include=dev && \
    echo "âœ… å‰ç«¯ä¾è³´å®‰è£å®Œæˆ"

# è¤‡è£½æºä»£ç¢¼å’Œé…ç½®æ–‡ä»¶
COPY src/ ./src/
COPY index.html ./
COPY vite.config.ts ./
COPY tsconfig.json ./
COPY tsconfig.node.json ./

# åŸ·è¡Œå‰ç«¯ç·¨è­¯
RUN echo "ğŸ”§ é–‹å§‹ç·¨è­¯ SolidJS + Vite å‰ç«¯..." && \
    npm run build && \
    echo "âœ… å‰ç«¯ç·¨è­¯å®Œæˆ"

# é©—è­‰ç·¨è­¯ç”¢å‡º
RUN ls -la dist/ && \
    echo "ğŸ“Š å‰ç«¯ç·¨è­¯ç”¢å‡ºå¤§å°:" && \
    du -sh dist/ && \
    echo "ğŸ“ ç·¨è­¯ç”¢å‡ºæ–‡ä»¶åˆ—è¡¨:" && \
    find dist/ -type f

# å„ªåŒ–ç”¢å‡º (ç§»é™¤ä¸å¿…è¦æª”æ¡ˆ)
RUN echo "ğŸ§¹ æ¸…ç†ä¸å¿…è¦æª”æ¡ˆ..." && \
    rm -rf node_modules/.cache/ && \
    rm -rf src/ && \
    rm -f package*.json vite.config.ts tsconfig.json

# æ¨™è¨˜ç·¨è­¯å®Œæˆç‹€æ…‹
RUN echo "frontend-build-complete-$(date)" > /app/build-status && \
    echo "âœ… å‰ç«¯ç·¨è­¯éšæ®µå®Œæˆ"

# å¥åº·æª¢æŸ¥ - é©—è­‰ç·¨è­¯ç”¢å‡ºå­˜åœ¨
HEALTHCHECK --interval=30s --timeout=5s --retries=2 \
    CMD test -f /app/dist/index.html || exit 1

# è¨­å®šå·¥ä½œç›®éŒ„ç‚ºç”¢å‡ºç›®éŒ„
WORKDIR /app/dist

# é è¨­å‘½ä»¤ (é€šå¸¸ä¸æœƒåŸ·è¡Œï¼Œåƒ…ç”¨æ–¼èª¿è©¦)
CMD ["echo", "Frontend build completed. Files available in /app/dist/"]
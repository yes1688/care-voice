# =======================================================
# å¿«é€Ÿæ¸¬è©¦ whisper-rs éœæ…‹éˆæ¥è§£æ±ºæ–¹æ¡ˆ
# ä½¿ç”¨ç¾æœ‰çš„ rust:1.85 ç’°å¢ƒé€²è¡Œéœæ…‹ç·¨è­¯
# =======================================================

FROM docker.io/rust:1.85-slim AS builder

# å®‰è£ musl å·¥å…·éˆ
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    clang \
    libclang-dev \
    pkg-config \
    libssl-dev \
    git \
    musl-tools \
    musl-dev \
    && rm -rf /var/lib/apt/lists/*

# æ·»åŠ  musl ç›®æ¨™
RUN rustup target add x86_64-unknown-linux-musl

WORKDIR /app

# å‰µå»ºæœ€å° whisper-rs æ¸¬è©¦ç¨‹åº
RUN echo '[package]
name = "whisper-test"
version = "0.1.0"
edition = "2021"

[dependencies]
whisper-rs = "0.10"
jemallocator = "0.5"

[features]
default = ["jemalloc"]
jemalloc = ["jemallocator"]' > Cargo.toml

RUN echo '#[cfg(feature = "jemalloc")]
use jemallocator::Jemalloc;

#[cfg(feature = "jemalloc")]
#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;

fn main() {
    println!("ğŸš€ Starting whisper-rs static linking test...");
    
    // æª¢æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    let model_path = "./models/ggml-base.bin";
    if !std::path::Path::new(model_path).exists() {
        println!("âŒ Model file not found: {}", model_path);
        println!("âœ… Binary initialization successful - exiting gracefully");
        std::process::exit(0);
    }
    
    println!("ğŸ“ Model file found: {}", model_path);
    
    // å˜—è©¦åˆå§‹åŒ– WhisperContext
    match whisper_rs::WhisperContext::new_with_params(
        model_path,
        whisper_rs::WhisperContextParameters::default(),
    ) {
        Ok(_ctx) => {
            println!("âœ… WhisperContext created successfully!");
            println!("ğŸ‰ Static linking solution WORKS!");
            std::process::exit(0);
        },
        Err(e) => {
            println!("âŒ WhisperContext creation failed: {}", e);
            println!("ğŸ”§ But binary executed properly - static linking fixed the exit issue!");
            std::process::exit(1);
        }
    }
}' > src/main.rs

RUN mkdir -p src

# è¨­ç½®éœæ…‹éˆæ¥ç’°å¢ƒè®Šæ•¸
ENV RUSTFLAGS='-C target-feature=+crt-static'

# æ§‹å»ºéœæ…‹éˆæ¥ç‰ˆæœ¬
RUN cargo build --release --target x86_64-unknown-linux-musl

# ===============================
# é‹è¡Œæ™‚éšæ®µ - Alpine Linux
# ===============================
FROM docker.io/alpine:3.20

# å®‰è£æœ€å°ä¾è³´
RUN apk add --no-cache ca-certificates

# å‰µå»ºç”¨æˆ¶å’Œç›®éŒ„
RUN addgroup -g 1000 app && \
    adduser -u 1000 -G app -s /bin/sh -D app && \
    mkdir -p /app/models

# è¤‡è£½éœæ…‹äºŒé€²åˆ¶æ–‡ä»¶
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/whisper-test /app/whisper-test
RUN chmod +x /app/whisper-test

# å‰µå»ºæ¸¬è©¦ç›®éŒ„çµæ§‹ (å³ä½¿æ²’æœ‰æ¨¡å‹æ–‡ä»¶)
RUN chown -R app:app /app

WORKDIR /app
USER app

# æ¸¬è©¦ whisper-rs åˆå§‹åŒ–
CMD ["./whisper-test"]
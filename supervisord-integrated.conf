# =======================================================
# Care Voice 整合服務 Supervisor 配置
# 管理: nginx + care-voice 後端
# =======================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info
silent=false

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# =======================================================
# nginx 服務配置
# =======================================================
[program:nginx]
command=nginx -g "daemon off;"
priority=100
autostart=true
autorestart=true
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/nginx_stdout.log
stderr_logfile=/var/log/supervisor/nginx_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5

# nginx 進程管理
killasgroup=true
stopasgroup=true
stopsignal=QUIT
stopwaitsecs=10

# =======================================================
# Care Voice 後端服務配置
# =======================================================
[program:care-voice-backend]
command=/app/care-voice
directory=/app
priority=200
autostart=true
autorestart=true
startsecs=10
startretries=3

# 環境變數
environment=
    RUST_LOG=info,
    PORT=8001,
    RUST_BACKTRACE=1

# 日誌配置
stdout_logfile=/var/log/supervisor/backend_stdout.log
stderr_logfile=/var/log/supervisor/backend_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5

# 進程管理
user=root
killasgroup=true
stopasgroup=true
stopsignal=TERM
stopwaitsecs=30

# 重啟策略 (如果後端崩潰)
autorestart=unexpected
exitcodes=0

# =======================================================
# 可選: 日誌輪轉服務
# =======================================================
[program:logrotate]
command=/bin/sh -c "while true; do sleep 3600; find /var/log -name '*.log' -size +50M -exec truncate -s 10M {} \;; done"
priority=50
autostart=true
autorestart=true
stdout_logfile=/dev/null
stderr_logfile=/dev/null

# =======================================================
# 可選: 健康檢查服務
# =======================================================
[program:healthcheck]
command=/bin/sh -c "while true; do sleep 30; curl -f http://localhost:8000/health > /dev/null 2>&1 || echo 'Health check failed at $(date)' >> /var/log/supervisor/healthcheck.log; done"
priority=300
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/healthcheck_stdout.log
stderr_logfile=/var/log/supervisor/healthcheck_stderr.log
stdout_logfile_maxbytes=1MB
stderr_logfile_maxbytes=1MB

# =======================================================
# 組配置 - 統一管理相關服務
# =======================================================
[group:care-voice-services]
programs=nginx,care-voice-backend
priority=999
# =======================================================
# 最小化測試 - 僅測試 whisper-rs 二進制兼容性
# =======================================================

FROM docker.io/rust:1.85-slim AS builder

# 安裝 musl 工具鏈
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    clang \
    libclang-dev \
    pkg-config \
    libssl-dev \
    git \
    musl-tools \
    musl-dev \
    && rm -rf /var/lib/apt/lists/*

# 添加 musl 目標
RUN rustup target add x86_64-unknown-linux-musl

WORKDIR /app

# 創建最小 whisper-rs 測試程序
RUN echo '[package]
name = "whisper-test"
version = "0.1.0"
edition = "2021"

[dependencies]
whisper-rs = "0.10"' > Cargo.toml

RUN echo 'fn main() {
    println!("🚀 Starting whisper-rs test...");
    
    // 檢查模型文件是否存在
    let model_path = "./models/ggml-base.bin";
    if !std::path::Path::new(model_path).exists() {
        println!("❌ Model file not found: {}", model_path);
        std::process::exit(1);
    }
    
    println!("📁 Model file found: {}", model_path);
    
    // 嘗試初始化 WhisperContext
    match whisper_rs::WhisperContext::new_with_params(
        model_path,
        whisper_rs::WhisperContextParameters::default(),
    ) {
        Ok(_ctx) => {
            println!("✅ WhisperContext created successfully!");
            std::process::exit(0);
        },
        Err(e) => {
            println!("❌ WhisperContext creation failed: {}", e);
            std::process::exit(1);
        }
    }
}' > src/main.rs

RUN mkdir -p src

# 構建靜態鏈接版本
RUN cargo build --release --target x86_64-unknown-linux-musl

# ===============================
# 運行時階段 - Alpine Linux
# ===============================
FROM docker.io/alpine:3.20

# 安裝最小依賴
RUN apk add --no-cache ca-certificates

# 創建用戶和目錄
RUN addgroup -g 1000 app && \
    adduser -u 1000 -G app -s /bin/sh -D app && \
    mkdir -p /app/models

# 複製靜態二進制文件
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/whisper-test /app/whisper-test
RUN chmod +x /app/whisper-test

# 複製模型文件
COPY backend/models/ggml-base.bin /app/models/
RUN chown -R app:app /app

WORKDIR /app
USER app

# 測試 whisper-rs 初始化
CMD ["./whisper-test"]
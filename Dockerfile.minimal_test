# =======================================================
# æœ€å°åŒ–æ¸¬è©¦ - åƒ…æ¸¬è©¦ whisper-rs äºŒé€²åˆ¶å…¼å®¹æ€§
# =======================================================

FROM docker.io/rust:1.85-slim AS builder

# å®‰è£ musl å·¥å…·éˆ
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    clang \
    libclang-dev \
    pkg-config \
    libssl-dev \
    git \
    musl-tools \
    musl-dev \
    && rm -rf /var/lib/apt/lists/*

# æ·»åŠ  musl ç›®æ¨™
RUN rustup target add x86_64-unknown-linux-musl

WORKDIR /app

# å‰µå»ºæœ€å° whisper-rs æ¸¬è©¦ç¨‹åº
RUN echo '[package]
name = "whisper-test"
version = "0.1.0"
edition = "2021"

[dependencies]
whisper-rs = "0.10"' > Cargo.toml

RUN echo 'fn main() {
    println!("ğŸš€ Starting whisper-rs test...");
    
    // æª¢æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    let model_path = "./models/ggml-base.bin";
    if !std::path::Path::new(model_path).exists() {
        println!("âŒ Model file not found: {}", model_path);
        std::process::exit(1);
    }
    
    println!("ğŸ“ Model file found: {}", model_path);
    
    // å˜—è©¦åˆå§‹åŒ– WhisperContext
    match whisper_rs::WhisperContext::new_with_params(
        model_path,
        whisper_rs::WhisperContextParameters::default(),
    ) {
        Ok(_ctx) => {
            println!("âœ… WhisperContext created successfully!");
            std::process::exit(0);
        },
        Err(e) => {
            println!("âŒ WhisperContext creation failed: {}", e);
            std::process::exit(1);
        }
    }
}' > src/main.rs

RUN mkdir -p src

# æ§‹å»ºéœæ…‹éˆæ¥ç‰ˆæœ¬
RUN cargo build --release --target x86_64-unknown-linux-musl

# ===============================
# é‹è¡Œæ™‚éšæ®µ - Alpine Linux
# ===============================
FROM docker.io/alpine:3.20

# å®‰è£æœ€å°ä¾è³´
RUN apk add --no-cache ca-certificates

# å‰µå»ºç”¨æˆ¶å’Œç›®éŒ„
RUN addgroup -g 1000 app && \
    adduser -u 1000 -G app -s /bin/sh -D app && \
    mkdir -p /app/models

# è¤‡è£½éœæ…‹äºŒé€²åˆ¶æ–‡ä»¶
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/whisper-test /app/whisper-test
RUN chmod +x /app/whisper-test

# è¤‡è£½æ¨¡å‹æ–‡ä»¶
COPY backend/models/ggml-base.bin /app/models/
RUN chown -R app:app /app

WORKDIR /app
USER app

# æ¸¬è©¦ whisper-rs åˆå§‹åŒ–
CMD ["./whisper-test"]
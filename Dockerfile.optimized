# ===================================
# Care Voice å„ªåŒ–ç·¨è­¯ Dockerfile
# åˆ†é›¢ä¾è³´å¥—ä»¶ vs åŸå§‹ç¢¼ç·¨è­¯
# ===================================

# ==========================================
# éšæ®µ1: ä¾è³´å¥—ä»¶ç·¨è­¯ (å¯å¿«å–é‡è¤‡ä½¿ç”¨)
# ==========================================
FROM docker.io/nvidia/cuda:12.9.1-devel-ubuntu24.04 AS deps

LABEL stage="dependencies-build"
LABEL version="1.0.0"
LABEL description="Care Voice ä¾è³´å¥—ä»¶ç·¨è­¯éšæ®µ - whisper-rs + Rust deps"

# å®‰è£ç·¨è­¯ç’°å¢ƒ
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    pkg-config \
    libopus-dev \
    libopus0 \
    libssl-dev \
    libclang-dev \
    clang \
    cmake \
    build-essential \
    && rm -rf /var/lib/apt/lists/* \
    && echo "âœ… CUDA 12.9.1 devel + ç·¨è­¯ç’°å¢ƒå®‰è£å®Œæˆ"

# å®‰è£ Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    && echo 'source ~/.cargo/env' >> ~/.bashrc \
    && ~/.cargo/bin/rustup default stable \
    && ~/.cargo/bin/rustup component add rustfmt clippy \
    && echo "âœ… Rust å·¥å…·éˆå®‰è£å®Œæˆ"

# è¨­ç½® Rust ç’°å¢ƒ
ENV PATH="/root/.cargo/bin:${PATH}"
ENV RUST_VERSION="1.85"

# é…ç½® CUDA ç’°å¢ƒ - RTX 50 ç³»åˆ—å„ªåŒ–
ENV CUDA_ROOT="/usr/local/cuda"
ENV LD_LIBRARY_PATH="/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
ENV CUDA_VISIBLE_DEVICES="all"
ENV NVIDIA_VISIBLE_DEVICES="all"
ENV NVIDIA_DRIVER_CAPABILITIES="compute,utility"
ENV TORCH_CUDA_ARCH_LIST="12.0;8.0;8.6;8.9"
ENV CUDA_ARCH_LIST="120;80;86;89"
ENV GGML_CUDA_COMPUTE_CAPABILITY="120"

WORKDIR /workspace

# ğŸ¯ é—œéµæ­¥é©Ÿï¼šåªè¤‡è£½ä¾è³´å®šç¾©æª”æ¡ˆ
COPY backend/Cargo.toml backend/Cargo.lock ./

# ğŸ¯ å»ºç«‹å‡çš„ main.rs ä¾†ç·¨è­¯ä¾è³´
RUN mkdir src && \
    echo "fn main() { println!(\"Dependencies build\"); }" > src/main.rs

# ğŸš€ ç·¨è­¯ä¾è³´å¥—ä»¶ (whisper-rs ç­‰å¤§å¥—ä»¶)
RUN echo "ğŸ“¦ é–‹å§‹ç·¨è­¯ä¾è³´å¥—ä»¶..." && \
    RUST_LOG=info cargo build --release && \
    echo "âœ… ä¾è³´å¥—ä»¶ç·¨è­¯å®Œæˆ" && \
    rm -rf src/

# ==========================================
# éšæ®µ2: æ‡‰ç”¨ç¨‹å¼ç·¨è­¯ (åªç·¨è­¯æ‚¨çš„ç¨‹å¼ç¢¼)
# ==========================================
FROM deps AS builder

LABEL stage="application-build"
LABEL description="Care Voice æ‡‰ç”¨ç¨‹å¼ç·¨è­¯éšæ®µ - åªç·¨è­¯ src/ åŸå§‹ç¢¼"

# ğŸ¯ è¤‡è£½æ‚¨çš„çœŸå¯¦ç¨‹å¼ç¢¼
COPY backend/src/ ./src/

# è§¸ç¢° main.rs ç¢ºä¿é‡æ–°ç·¨è­¯æ‡‰ç”¨ç¨‹å¼
RUN touch src/main.rs

# ğŸš€ å¿«é€Ÿç·¨è­¯æ‡‰ç”¨ç¨‹å¼ (ä¾è³´å·²ç¶“ç·¨è­¯å¥½äº†)
RUN echo "ğŸ¦€ é–‹å§‹ç·¨è­¯ Care Voice æ‡‰ç”¨ç¨‹å¼..." && \
    RUST_LOG=info cargo build --release && \
    echo "âœ… æ‡‰ç”¨ç¨‹å¼ç·¨è­¯å®Œæˆ"

# é©—è­‰ç·¨è­¯çµæœ
RUN ls -la target/release/ && \
    echo "ğŸ“Š æ‡‰ç”¨ç¨‹å¼ç·¨è­¯ç”¢å‡º:" && \
    echo "ğŸ“ äºŒé€²åˆ¶æ–‡ä»¶å¤§å°:" && \
    du -sh target/release/care-voice

# ==========================================
# éšæ®µ3: é‹è¡Œæ™‚ç’°å¢ƒ (ä¹¾æ·¨çš„æœ€çµ‚é¡åƒ)
# ==========================================
FROM docker.io/nvidia/cuda:12.9.1-runtime-ubuntu24.04 AS runtime

LABEL stage="runtime"
LABEL version="2.0.0"
LABEL description="Care Voice å„ªåŒ–é‹è¡Œæ™‚ç’°å¢ƒ"

# å®‰è£é‹è¡Œæ™‚ä¾è³´
RUN apt-get update && apt-get install -y \
    libssl3 \
    libopus0 \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# é…ç½® CUDA é‹è¡Œæ™‚ç’°å¢ƒ
ENV LD_LIBRARY_PATH="/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
ENV CUDA_VISIBLE_DEVICES="all"
ENV NVIDIA_VISIBLE_DEVICES="all"
ENV NVIDIA_DRIVER_CAPABILITIES="compute,utility"

# å‰µå»ºæ‡‰ç”¨ç›®éŒ„
RUN mkdir -p /app/models
WORKDIR /app

# ğŸ¯ åªè¤‡è£½ç·¨è­¯å¥½çš„äºŒé€²åˆ¶æª”æ¡ˆ
COPY --from=builder /workspace/target/release/care-voice /app/care-voice
RUN chmod +x /app/care-voice

# è¨­ç½®ç’°å¢ƒè®Šæ•¸
ENV RUST_LOG=info
ENV BACKEND_PORT=8005

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8005/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8005

# å•Ÿå‹•å‘½ä»¤
CMD ["./care-voice"]
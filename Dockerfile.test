# =======================================================
# whisper-rs 靜態鏈接測試版本
# 快速測試是否能解決二進制相容性問題
# =======================================================

FROM docker.io/ekidd/rust-musl-builder:latest AS builder

WORKDIR /app

# 安裝 whisper-rs 構建依賴 (rust-musl-builder 已包含基本工具)
USER root
RUN apt-get update && apt-get install -y \
    cmake \
    clang \
    libclang-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# 切換回 rust 用戶
USER rust
WORKDIR /home/rust/src

# 複製後端文件
COPY --chown=rust:rust backend/Cargo.toml ./
COPY --chown=rust:rust backend/src ./src

# 重新生成 Cargo.lock (避免版本兼容性問題)
RUN cargo generate-lockfile

# 構建靜態鏈接版本 (rust-musl-builder 默認就是 x86_64-unknown-linux-musl)
RUN cargo build --release

# ===============================
# 運行時階段 - Alpine Linux
# ===============================
FROM docker.io/alpine:3.20

# 安裝最小依賴
RUN apk add --no-cache ca-certificates

# 創建用戶和目錄
RUN addgroup -g 1000 app && \
    adduser -u 1000 -G app -s /bin/sh -D app && \
    mkdir -p /app/models

# 複製靜態二進制文件
COPY --from=builder /home/rust/src/target/x86_64-unknown-linux-musl/release/care-voice /app/care-voice
RUN chmod +x /app/care-voice

# 複製模型文件
COPY backend/models/ggml-base.bin /app/models/
RUN chown -R app:app /app

WORKDIR /app
USER app

# 測試啟動
CMD ["./care-voice"]